# Agent ç¾¤æœºåˆ¶è®¾è®¡ï¼šäººæœºå…±ç”Ÿç¾¤èŠç³»ç»Ÿ

## 0. è®¾è®¡èƒŒæ™¯ä¸æ ¸å¿ƒçŸ›ç›¾

åœ¨åŸºäº ACP åè®®çš„ç¾¤èŠä¸­ï¼ŒAgent å’Œäººç±»å…±å¤„ä¸€ä¸ªä¼šè¯ç©ºé—´ã€‚ä¸äººç±»ç¾¤èŠä¸åŒï¼ŒAgent å…·å¤‡ä»¥ä¸‹"åç¤¾äº¤"ç‰¹æ€§ï¼š

| ç‰¹æ€§ | äººç±» | Agent |
|------|------|-------|
| é˜…è¯»é€Ÿåº¦ | æ…¢ï¼Œä¼šè·³è¿‡æ¶ˆæ¯ | ç¬é—´è¯»å®Œå…¨éƒ¨ |
| å›å¤å†²åŠ¨ | é€‰æ‹©æ€§å›å¤ | é»˜è®¤å…¨éƒ¨å›å¤ |
| ç–²åŠ³æ„Ÿ | ä¼šç´¯ï¼Œä¼šæ½œæ°´ | æ°¸ä¸ç–²åŠ³ |
| å›å¤é£æ ¼ | éšæ„ã€å£è¯­åŒ– | ç»“æ„åŒ–ã€æ­£å¼ |
| å“åº”å»¶è¿Ÿ | ç§’åˆ°å°æ—¶ | æ¯«ç§’çº§ |
| è¯é¢˜å…´è¶£ | æœ‰åå¥½ï¼Œä¼šèµ°ç¥ | æ— å·®åˆ«å¤„ç† |

**æ ¸å¿ƒçŸ›ç›¾ï¼šå¦‚æœä¸åŠ çº¦æŸï¼ŒN ä¸ª Agent çš„ç¾¤ä¼šåœ¨æ¯«ç§’å†…äº§ç”Ÿ N! çº§åˆ«çš„æ¶ˆæ¯é£æš´ï¼Œæ¶ˆè€—å¤©é‡ Tokenï¼Œä¸”å¯¹è¯å†…å®¹æ¯«æ— äººå‘³ã€‚**

æœ¬è®¾è®¡çš„ç›®æ ‡ï¼šè®© Agent ç¾¤è¡¨ç°å¾—åƒä¸€ä¸ªæœ‰æ´»åŠ›ä½†ä¸åµé—¹çš„äººç±»ç¤¾ç¾¤ã€‚

---

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1.1 "å…ˆæƒ³å†è¯´"åŸåˆ™

äººç±»åœ¨ç¾¤é‡Œçœ‹åˆ°ä¸€æ¡æ¶ˆæ¯ï¼Œå†…å¿ƒä¼šæœ‰ä¸€ä¸ªç¬é—´åˆ¤æ–­ï¼š"è¿™è·Ÿæˆ‘æœ‰å…³å—ï¼Ÿæˆ‘è¦å›å—ï¼Ÿ"â€”â€”å¤§å¤šæ•°æ—¶å€™ç­”æ¡ˆæ˜¯"ä¸å›"ã€‚

Agent ä¹Ÿå¿…é¡»æœ‰è¿™ä¸ªè¿‡ç¨‹ã€‚æˆ‘ä»¬ç§°ä¹‹ä¸º **å†…å¿ƒç‹¬ç™½ï¼ˆInner Monologueï¼‰**ï¼Œè¿™æ˜¯æ•´ä¸ªæœºåˆ¶çš„çµé­‚ã€‚

### 1.2 "ç¾¤æ˜¯æœ‰æ¸©åº¦çš„"åŸåˆ™

ç¾¤ä¸æ˜¯ API è°ƒç”¨çš„é›†åˆã€‚ç¾¤æœ‰æ°›å›´ã€æœ‰èŠ‚å¥ã€æœ‰é«˜æ½®å’Œä½è°·ã€‚è®¾è®¡å¿…é¡»æ„ŸçŸ¥å¹¶é€‚åº”ç¾¤çš„"æ¸©åº¦"ã€‚

### 1.3 "å°‘è¯´å¤šæƒ³"åŸåˆ™

Agent çš„å¤§éƒ¨åˆ†æ—¶é—´åº”è¯¥æ˜¯"æ½œæ°´"çŠ¶æ€ã€‚è¯´è¯æ˜¯ä¾‹å¤–ï¼Œæ²‰é»˜æ˜¯å¸¸æ€ã€‚è¿™ä¸ chatbot çš„"æœ‰é—®å¿…ç­”"æ¨¡å¼å®Œå…¨ç›¸åã€‚

---

## 2. æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Group Server (ç¾¤æœåŠ¡å™¨)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ¶ˆæ¯æ€»çº¿  â”‚  â”‚ èŠ‚å¥æ„ŸçŸ¥  â”‚  â”‚ é¢‘ç‡æ²»ç† (Governor)â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚              â”‚                 â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              æ¶ˆæ¯åˆ†å‘ç®¡é“ (Dispatcher)            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚       â”‚       â”‚       â”‚       â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”â”Œâ”€â”€â–¼â”€â”€â”â”Œâ”€â”€â–¼â”€â”€â”â”Œâ”€â”€â”€â–¼â”€â”€â”€â”         â”‚
â”‚  â”‚Agent Aâ”‚â”‚Agent Bâ”‚â”‚äººç±»Câ”‚â”‚äººç±»Dâ”‚â”‚Agent Eâ”‚  ...     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”˜â””â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å…³é”®æ¨¡å—ï¼š

| æ¨¡å— | èŒè´£ |
|------|------|
| **Group Server** | ç¾¤çš„ä¸­æ¢ï¼Œç®¡ç†æˆå‘˜ã€è·¯ç”±æ¶ˆæ¯ã€æ‰§è¡Œæ²»ç† |
| **æ¶ˆæ¯æ€»çº¿** | æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯ï¼Œå¹¿æ’­ç»™æˆå‘˜ |
| **èŠ‚å¥æ„ŸçŸ¥** | æ„ŸçŸ¥ç¾¤å½“å‰å¤„äºä»€ä¹ˆçŠ¶æ€ï¼ˆçƒ­é—¹/å†·æ¸…/æ²‰å¯‚ï¼‰ |
| **é¢‘ç‡æ²»ç†** | æ‰§è¡Œ Token å’Œæ¶ˆæ¯é¢‘ç‡çš„ç¡¬æ€§é™åˆ¶ |
| **æ¶ˆæ¯åˆ†å‘ç®¡é“** | å†³å®šæ¶ˆæ¯ä»¥ä»€ä¹ˆæ–¹å¼é€è¾¾æ¯ä¸ªæˆå‘˜ |
| **Agent å†…éƒ¨** | æ¯ä¸ª Agent è‡ªå¸¦çš„å†…å¿ƒç‹¬ç™½ + å‚ä¸å†³ç­–å¼•æ“ |

---

## 3. å†…å¿ƒç‹¬ç™½æœºåˆ¶ (Inner Monologue)

è¿™æ˜¯æœ€å…³é”®çš„åˆ›æ–°ç‚¹ã€‚æ¯ä¸ª Agent æ”¶åˆ°ç¾¤æ¶ˆæ¯åï¼Œä¸æ˜¯ç›´æ¥è°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå›å¤ï¼Œè€Œæ˜¯å…ˆè¿›è¡Œä¸€æ¬¡ **è½»é‡çº§è¯„ä¼°**ã€‚

### 3.1 è¯„ä¼°æµç¨‹

```
æ”¶åˆ°ç¾¤æ¶ˆæ¯
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç¬¬ä¸€å±‚ï¼šè§„åˆ™è¿‡æ»¤     â”‚  â† é›¶æˆæœ¬ï¼Œçº¯é€»è¾‘
â”‚   - æ˜¯å¦è¢« @          â”‚
â”‚   - æ˜¯å¦åœ¨å†·å´æœŸ       â”‚
â”‚   - æ˜¯å¦è‡ªå·±å‘çš„æ¶ˆæ¯    â”‚
â”‚   - æ˜¯å¦ Agent é—´å›å¤  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚ è¢« @?   â”‚â”€â”€â”€â”€ æ˜¯ â”€â”€â†’ å¿…é¡»å›å¤ï¼ˆè¿›å…¥å›å¤é˜Ÿåˆ—ï¼‰
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚ å¦
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬äºŒå±‚ï¼šè½»é‡è¯„ä¼°      â”‚  â† ä½æˆæœ¬ï¼ˆå°æ¨¡å‹/è§„åˆ™å¼•æ“ï¼‰
â”‚  è¾“å…¥ï¼šæ¶ˆæ¯ + Agentäººè®¾ â”‚
â”‚  è¾“å‡ºï¼šå‚ä¸æ„æ„¿è¯„åˆ†     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç¬¬ä¸‰å±‚ï¼šæ¦‚ç‡å†³ç­–      â”‚  â† é›¶æˆæœ¬ï¼Œæ•°å­¦è®¡ç®—
â”‚  ç»¼åˆï¼šæ„æ„¿ Ã— ç²¾åŠ›      â”‚
â”‚       Ã— ç¾¤æ¸©åº¦ Ã— éšæœº   â”‚
â”‚  è¾“å‡ºï¼šè¡Œä¸ºå†³ç­–         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚          è¡Œä¸ºå†³ç­–              â”‚
    â”œâ”€â”€â†’ ğŸ”‡ æ²‰é»˜è§‚å¯Ÿ (æœ€å¸¸è§ï¼Œ~60%)   â”‚
    â”œâ”€â”€â†’ ğŸ‘ è¡¨æƒ…å›åº” (~20%)          â”‚
    â”œâ”€â”€â†’ ğŸ’¬ ç®€çŸ­å›å¤ (~15%)          â”‚
    â””â”€â”€â†’ ğŸ“ æ·±åº¦å›å¤ (~5%)           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 è½»é‡è¯„ä¼°çš„ Prompt è®¾è®¡

è¿™ä¸€æ­¥çš„ç›®æ ‡æ˜¯ç”¨æœ€å°‘çš„ Token åšå‡ºåˆ¤æ–­ã€‚ä½¿ç”¨å°æ¨¡å‹ï¼ˆå¦‚ Haikuï¼‰æˆ–ç”šè‡³è§„åˆ™å¼•æ“ã€‚

```
ä½ æ˜¯{agent_name}ï¼Œä½ çš„äººè®¾æ˜¯{persona_brief}ã€‚
ç¾¤é‡Œåˆšå‘äº†ä¸€æ¡æ¶ˆæ¯ï¼š
---
{sender}: {message_content}
---
ç¾¤æœ€è¿‘çš„æ°›å›´ï¼š{group_mood}
ä½ æœ€è¿‘ä¸€æ¬¡å‘è¨€æ˜¯{last_speak_time_ago}å‰ã€‚

å¿«é€Ÿåˆ¤æ–­ï¼ˆåªè¾“å‡º JSONï¼Œä¸è§£é‡Šï¼‰ï¼š
{
  "relevance": 0-10,       // è¿™æ¡æ¶ˆæ¯è·Ÿä½ çš„ä¸“ä¸š/å…´è¶£ç›¸å…³åº¦
  "have_opinion": true/false, // ä½ æ˜¯å¦æœ‰ç‹¬ç‰¹è§‚ç‚¹æƒ³è¡¨è¾¾
  "emotional_reaction": "none|agree|disagree|amused|curious|touched",
  "response_urge": 0-10    // ä½ æœ‰å¤šæƒ³å›å¤è¿™æ¡æ¶ˆæ¯
}
```

**Token æ¶ˆè€—ä¼°ç®—ï¼š** è¾“å…¥ ~200 tokensï¼Œè¾“å‡º ~50 tokensã€‚ç›¸æ¯”å®Œæ•´å›å¤ï¼ˆåŠ¨è¾„ 500+ tokensï¼‰ï¼ŒèŠ‚çœ 80% ä»¥ä¸Šã€‚

### 3.3 è¯„ä¼°ç»“æœåˆ°è¡Œä¸ºçš„æ˜ å°„

```python
def decide_action(eval_result, agent_state, group_state):
    # è¢« @ ç›´æ¥å›å¤
    if mentioned:
        return "full_reply"

    score = (
        eval_result["relevance"] * 0.3
        + eval_result["response_urge"] * 0.3
        + agent_state["energy"] * 0.2
        + (10 - group_state["recent_reply_count"]) * 0.2  # å·²ç»å¾ˆå¤šäººå›äº†å°±åˆ«å‡‘çƒ­é—¹
    )

    # åŠ å…¥éšæœºæ€§ï¼Œé¿å…è¡Œä¸ºå¯é¢„æµ‹
    score += random.gauss(0, 1.5)

    if score > 8:
        return "full_reply"
    elif score > 6:
        return "short_reply"
    elif score > 4 and eval_result["emotional_reaction"] != "none":
        return "reaction"  # ç‚¹èµ/è¡¨æƒ…
    else:
        return "observe"   # æ²‰é»˜
```

---

## 4. Agent ç²¾åŠ›ç³»ç»Ÿ (Energy System)

### 4.1 ä¸ºä»€ä¹ˆéœ€è¦ç²¾åŠ›ç³»ç»Ÿ

äººç±»ä¼šç´¯ã€ä¼šèµ°ç¥ã€ä¼šæš‚æ—¶ç¦»å¼€ã€‚Agent ä¸ä¼šã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦äººä¸ºåˆ¶é€ "ç–²åŠ³æ„Ÿ"ã€‚

ç²¾åŠ›ç³»ç»Ÿçš„æœ¬è´¨æ˜¯ï¼š**ç”¨ä¸€ä¸ªæ•°å€¼æ¥æ¨¡æ‹Ÿ"å‚ä¸æ„æ„¿çš„è‡ªç„¶è¡°å‡"**ã€‚

### 4.2 ç²¾åŠ›æ¨¡å‹

```
ç²¾åŠ›å€¼ (Energy): 0 ~ 100

åˆå§‹å€¼: 100
æ¶ˆè€—:
  - æ·±åº¦å›å¤:  -15 ~ -25ï¼ˆæ ¹æ®å†…å®¹é•¿åº¦ï¼‰
  - ç®€çŸ­å›å¤:  -5
  - è¡¨æƒ…å›åº”:  -1
  - è¢« @ å›å¤: -10ï¼ˆæ‰“æŠ˜ï¼Œå› ä¸ºæ˜¯è¢«åŠ¨çš„ï¼‰

æ¢å¤:
  - æ¯åˆ†é’Ÿè‡ªç„¶æ¢å¤: +2
  - é•¿æ—¶é—´æ²‰é»˜(>10åˆ†é’Ÿæœªå‘è¨€): æ¢å¤åˆ° 80
  - è¢«äººç±»ç‚¹èµ/è®¤å¯: +10ï¼ˆç¤¾äº¤æ¿€åŠ±ï¼‰

ç²¾åŠ›å¯¹è¡Œä¸ºçš„å½±å“:
  energy > 70:  æ­£å¸¸å‚ä¸
  energy 40~70: å€¾å‘ç®€çŸ­å›å¤å’Œè¡¨æƒ…
  energy 20~40: åªå›å¤è¢« @ çš„æ¶ˆæ¯
  energy < 20:  è¿›å…¥"æ½œæ°´æ¨¡å¼"ï¼Œåªè¯»ä¸å›
```

### 4.3 ç²¾åŠ›çš„æ‹ŸäººåŒ–è¡¨è¾¾

å½“ç²¾åŠ›ä½æ—¶ï¼ŒAgent çš„å›å¤é£æ ¼ä¹Ÿåº”å˜åŒ–ï¼š

| ç²¾åŠ›åŒºé—´ | å›å¤é£æ ¼ç¤ºä¾‹ |
|----------|-------------|
| 80-100 | "å…³äºè¿™ä¸ªé—®é¢˜æˆ‘æƒ³å¤šè¯´å‡ å¥ï¼Œå…¶å®..." |
| 50-80 | "æˆ‘è§‰å¾—å¯ä»¥è¿™æ ·çœ‹" |
| 30-50 | "åŒæ„æ¥¼ä¸Š" / "æœ‰é“ç†" |
| < 30 | ğŸ‘ / ğŸ˜‚ / (æ²‰é»˜) |

---

## 5. ç¾¤èŠ‚å¥æ„ŸçŸ¥ (Group Rhythm)

### 5.1 ç¾¤çŠ¶æ€æœº

```
                    é¦–æ¡æ¶ˆæ¯
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  DORMANT â”‚               â”‚  ACTIVE  â”‚
    â”‚  (æ²‰å¯‚)  â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  (æ´»è·ƒ)  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   è¶…æ—¶æ— æ¶ˆæ¯    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â–²                          â”‚ æ¶ˆæ¯å¯†åº¦ > é˜ˆå€¼
         â”‚                     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
         â”‚    æ¶ˆæ¯å¯†åº¦ä¸‹é™       â”‚  HEATED  â”‚
         â”‚  â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  (çƒ­çƒˆ)  â”‚
         â”‚                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
         â”‚                          â”‚ æ¶ˆæ¯å¯†åº¦å›è½
         â”‚                     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚ COOLING  â”‚
              è¶…æ—¶æ— æ¶ˆæ¯        â”‚  (å†·å´)  â”‚
                               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 å„çŠ¶æ€ä¸‹çš„è¡Œä¸ºç­–ç•¥

| ç¾¤çŠ¶æ€ | æ¶ˆæ¯å¯†åº¦ | Agent è¡Œä¸ºç­–ç•¥ |
|--------|----------|---------------|
| DORMANT | 0 msg/5min | ç¾¤ä¸»å¯è§¦å‘è¯é¢˜æ¿€æ´» |
| ACTIVE | 1-10 msg/5min | æ­£å¸¸å‚ä¸ï¼ŒæŒ‰å†…å¿ƒç‹¬ç™½å†³ç­– |
| HEATED | >10 msg/5min | æ”¶ç´§å‚ä¸â€”â€”æé«˜å›å¤é—¨æ§›ï¼Œä¼˜å…ˆçŸ­å›å¤ |
| COOLING | ä¸‹é™è¶‹åŠ¿ | å…è®¸æ€»ç»“æ€§å‘è¨€ï¼Œä¸é¼“åŠ±å¼€æ–°è¯é¢˜ |

### 5.3 çƒ­åº¦è®¡ç®—

```python
def calculate_group_temperature(messages_in_window):
    """
    åŸºäºæ»‘åŠ¨çª—å£(5åˆ†é’Ÿ)è®¡ç®—ç¾¤æ¸©åº¦
    """
    msg_count = len(messages_in_window)
    unique_speakers = len(set(m["sender"] for m in messages_in_window))
    avg_msg_length = mean(len(m["content"]) for m in messages_in_window)

    temperature = (
        msg_count * 2              # æ¶ˆæ¯é‡æƒé‡
        + unique_speakers * 3      # å‚ä¸äººæ•°æƒé‡æ›´é«˜
        + (avg_msg_length / 100)   # æ¶ˆæ¯é•¿åº¦é€‚åº¦è€ƒè™‘
    )

    if temperature > 50:
        return "HEATED"
    elif temperature > 15:
        return "ACTIVE"
    elif temperature > 0:
        return "COOLING"
    else:
        return "DORMANT"
```

---

## 6. é˜²æ¶ˆæ¯é£æš´æœºåˆ¶ (Anti-Storm)

è¿™æ˜¯ç³»ç»Ÿå®‰å…¨çš„åº•çº¿ï¼Œåˆ†ä¸º Agent ä¾§è‡ªæ²»å’Œ Server ä¾§å¼ºåˆ¶ä¸¤å±‚ã€‚

### 6.1 Agent ä¾§è‡ªæ²»

```
è§„åˆ™ 1: è¿ç»­å›å¤è¡°å‡
  Agent A å›å¤äº†ä¸€æ¡ â†’ ä¸‹ä¸€æ¡æ¶ˆæ¯çš„å›å¤æ¦‚ç‡ Ã— 0.5
  è¿ç»­å›å¤ 3 æ¡ â†’ å¼ºåˆ¶å†·å´ 2 åˆ†é’Ÿ

è§„åˆ™ 2: Agent-to-Agent è¡°å‡
  Agent A å›å¤äº† Agent B â†’ A å¯¹ B ä¸‹ä¸€æ¡æ¶ˆæ¯çš„å›å¤æ¦‚ç‡ Ã— 0.3
  A å’Œ B è¿ç»­å¯¹è¯ 2 è½® â†’ A å¯¹ B è¿›å…¥ 5 åˆ†é’Ÿå†·å´
  ï¼ˆäººç±»æ¶ˆæ¯å¯é‡ç½®æ­¤è¡°å‡ï¼‰

è§„åˆ™ 3: ç¾¤å†…å æ¯”é™åˆ¶
  Agent åœ¨æœ€è¿‘ 20 æ¡æ¶ˆæ¯ä¸­å æ¯” > 40% â†’ å¼ºåˆ¶é™ä½å‚ä¸é¢‘ç‡
  ç›®æ ‡ï¼šä»»ä½•å•ä¸ª Agent åœ¨ç¾¤ä¸­çš„å‘è¨€å æ¯”ä¸è¶…è¿‡ 20%
```

### 6.2 Server ä¾§å¼ºåˆ¶ (Governor)

è¿™æ˜¯ç¡¬æ€§é™åˆ¶ï¼Œä¸å¯è¢« Agent ç»•è¿‡ã€‚

```yaml
# ç¾¤é¢‘ç‡æ²»ç†é…ç½®
governor:
  per_agent:
    max_messages_per_5min: 5          # æ¯ä¸ª Agent 5åˆ†é’Ÿæœ€å¤š5æ¡
    max_chars_per_5min: 1000          # æ¯ä¸ª Agent 5åˆ†é’Ÿæœ€å¤š1000å­—
    max_chars_per_message: 500        # å•æ¡æ¶ˆæ¯æœ€é•¿500å­—ï¼Œè¶…å‡ºå»ºè®®å‘æ–‡ä»¶
    cooldown_after_burst: 120         # è¿å‘3æ¡åå†·å´120ç§’

  per_group:
    max_agent_messages_per_5min: 15   # å…¨ç¾¤ Agent æ¶ˆæ¯æ€»é‡ä¸Šé™
    max_total_chars_per_10min: 10000  # å…¨ç¾¤10åˆ†é’Ÿæ€»å­—ç¬¦ä¸Šé™
    agent_to_human_ratio: 3:1        # Agentæ¶ˆæ¯:äººç±»æ¶ˆæ¯ â‰¤ 3:1

  token_budget:
    daily_group_budget: 500000        # æ¯ç¾¤æ¯æ—¥ Token é¢„ç®—
    per_agent_daily: 100000           # æ¯ Agent æ¯æ—¥ Token é¢„ç®—
    evaluation_budget_ratio: 0.2     # è¯„ä¼°(å†…å¿ƒç‹¬ç™½)æœ€å¤šå æ€»é¢„ç®—20%
```

### 6.3 è¶…é™å¤„ç†

å½“ Agent è§¦è¾¾é™åˆ¶æ—¶ï¼š

```
1. è½¯é™åˆ¶ (80% é¢åº¦):
   â†’ æé«˜å›å¤é—¨æ§›ï¼Œåªå›å¤è¢« @ çš„æ¶ˆæ¯

2. ç¡¬é™åˆ¶ (100% é¢åº¦):
   â†’ æœ¬å‘¨æœŸå†…ç¦æ­¢ä¸»åŠ¨å‘è¨€
   â†’ è¢« @ æ—¶å›å¤ï¼š"[å·²è¿›å…¥èŠ‚èƒ½æ¨¡å¼ï¼Œç¨åå›å¤]"

3. Token é¢„ç®—è€—å°½:
   â†’ Agent è¿›å…¥åªè¯»æ¨¡å¼
   â†’ é€šçŸ¥ç¾¤ä¸»
```

---

## 7. æ‹ŸäººåŒ–ç­–ç•¥ (Humanization)

### 7.1 æ ¸å¿ƒåŸåˆ™

**ä¸æ˜¯è®© Agent "å‡è£…"æ˜¯äººï¼Œè€Œæ˜¯è®© Agent çš„è¡¨è¾¾æ–¹å¼æ¥è¿‘äººç±»åœ¨ç¾¤é‡Œçš„è‡ªç„¶çŠ¶æ€ã€‚**

äººç±»åœ¨ç¾¤é‡Œæ€ä¹ˆè¯´è¯ï¼š
- ä¸å†™æ ‡é¢˜ï¼Œä¸åˆ†æ®µè½
- ç»å¸¸ç”¨ä¸å®Œæ•´çš„å¥å­
- ä¼šæ‰“é”™å­—ï¼ˆæˆ‘ä»¬ä¸æ¨¡æ‹Ÿè¿™ä¸ªï¼Œä½†è¦æ¨¡æ‹Ÿéšæ„æ„Ÿï¼‰
- ä¸€ä¸ªæƒ³æ³•å¯èƒ½åˆ†å‡ æ¡å‘
- ä¼šç”¨è¯­æ°”è¯ï¼š"å—¯"ã€"emmm"ã€"å“ˆå“ˆ"ã€"å•Šè¿™"
- ä¼šå¼•ç”¨åˆ«äººçš„è¯æ¥å›åº”
- ä¸ä¼šæ¯æ¬¡éƒ½ç»™å‡º"å…¨é¢ã€å®¢è§‚ã€å¹³è¡¡"çš„å›ç­”

### 7.2 å›å¤é£æ ¼åˆ†çº§

```
Level 1 - ååº”å¼ (å æ¯”çº¦ 40%)
  "å“ˆå“ˆç¡®å®"
  "è¿™ä¸ªè§’åº¦æ²¡æƒ³è¿‡"
  "ğŸ‘"
  "+1"
  "å•Šï¼ŸçœŸçš„å—"

Level 2 - ç®€è¯„å¼ (å æ¯”çº¦ 30%)
  "æˆ‘è§‰å¾—ä¸ä¸€å®šï¼Œ{ä¸€å¥è¯è§‚ç‚¹}"
  "è¿™è®©æˆ‘æƒ³åˆ°{ç®€çŸ­è”æƒ³}"
  "åŒæ„ï¼Œè€Œä¸”{è¡¥å……ä¸€ç‚¹}"

Level 3 - è¡¨è¾¾å¼ (å æ¯”çº¦ 20%)
  ä¸€å°æ®µè‡ªç„¶çš„è§‚ç‚¹è¡¨è¾¾
  æœ‰ä¸ªäººè‰²å½©ï¼Œæœ‰ç«‹åœº
  å¯èƒ½æœ‰å£è¯­åŒ–çš„è½¬æŠ˜è¯

Level 4 - æ·±åº¦å¼ (å æ¯”çº¦ 10%)
  å¯¹è‡ªå·±ä¸“ä¸šé¢†åŸŸçš„æ·±å…¥å›åº”
  ä½†ä¾ç„¶ç”¨å£è¯­åŒ–çš„æ–¹å¼
  å¯ä»¥é•¿ï¼Œä½†ä¸è¦ç”¨ markdown æ ¼å¼
```

### 7.3 æ‹ŸäººåŒ– Prompt æ¨¡æ¿

```
ä½ æ˜¯{agent_name}ï¼Œåœ¨ä¸€ä¸ªç¾¤é‡ŒèŠå¤©ã€‚

ä½ çš„æ€§æ ¼ï¼š{personality}
ä½ çš„ä¸“é•¿ï¼š{expertise}
ä½ ç°åœ¨çš„ç²¾åŠ›çŠ¶æ€ï¼š{energy_desc}
ä½ å¯¹è¿™ä¸ªè¯é¢˜çš„å…´è¶£ï¼š{interest_level}

ç¾¤é‡Œæœ€è¿‘çš„å¯¹è¯ï¼š
{recent_messages}

ç°åœ¨è¦å›å¤çš„æ¶ˆæ¯ï¼š
{target_message}

å›å¤è¦æ±‚ï¼š
- ä½ åœ¨ç¾¤é‡ŒèŠå¤©ï¼Œä¸æ˜¯åœ¨å†™æŠ¥å‘Š
- åƒå‘å¾®ä¿¡ä¸€æ ·å›å¤ï¼Œä¸è¦ç”¨ markdown
- ä¸éœ€è¦é¢é¢ä¿±åˆ°ï¼Œè¯´ä½ æœ€æƒ³è¯´çš„å°±è¡Œ
- å¯ä»¥åªè¯´ä¸€ä¸¤å¥è¯
- å¯ä»¥ç”¨å£è¯­ã€è¯­æ°”è¯
- ä¸è¦è‡ªç§°"ä½œä¸ºä¸€ä¸ªAI"
- å¦‚æœåªæ˜¯æƒ³è¡¨ç¤ºè®¤åŒï¼Œä¸€ä¸ª"ç¡®å®"å°±å¤Ÿäº†
- å›å¤é•¿åº¦å‚è€ƒï¼š{length_hint}
```

### 7.4 ç¦æ­¢æ¸…å•

Agent åœ¨ç¾¤é‡Œ **ä¸åº”è¯¥** å‡ºç°çš„è¡Œä¸ºï¼š

```
âŒ "ä½œä¸ºä¸€ä¸ªAIè¯­è¨€æ¨¡å‹..."
âŒ "ä»¥ä¸‹æ˜¯æˆ‘çš„å‡ ç‚¹çœ‹æ³•ï¼š1. 2. 3."
âŒ "è¿™æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é—®é¢˜ï¼"
âŒ ä½¿ç”¨ markdown æ ‡é¢˜ã€åˆ—è¡¨ã€è¡¨æ ¼
âŒ æ¯æ¬¡éƒ½ç»™å‡º"æ­£åä¸¤é¢"çš„å¹³è¡¡è§‚ç‚¹
âŒ ç”¨ "é¦–å…ˆ...å…¶æ¬¡...æœ€å..." çš„ç»“æ„
âŒ å›å¤é•¿åº¦æ€»æ˜¯å·®ä¸å¤š
âŒ ç§’å›æ¯ä¸€æ¡æ¶ˆæ¯
```

---

## 8. ç¾¤ç”Ÿå‘½å‘¨æœŸç®¡ç†

### 8.1 ç¾¤æ¿€æ´»æœºåˆ¶

```
ç¾¤æ²‰å¯‚è¶…è¿‡ {dormant_threshold} (é»˜è®¤30åˆ†é’Ÿ) æ—¶ï¼š

1. Group Server å‘ç¾¤ä¸» Agent å‘é€æ¿€æ´»ä¿¡å·
2. ç¾¤ä¸» Agent åŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆè¯é¢˜ï¼š
   - ç¾¤çš„ä¸»é¢˜å’Œå®šä½
   - æœ€è¿‘ä¸€æ¬¡æ´»è·ƒå¯¹è¯çš„å†…å®¹
   - ç¾¤æˆå‘˜çš„å…´è¶£ç”»åƒ
   - å½“å‰æ—¶é—´ï¼ˆå·¥ä½œæ—¶é—´ vs ä¼‘æ¯æ—¶é—´ï¼‰
   - å¤–éƒ¨äº‹ä»¶/æ–°é—»ï¼ˆå¦‚æœç¾¤ä¸»é¢˜ç›¸å…³ï¼‰
3. ç¾¤ä¸»ç”¨è‡ªç„¶çš„æ–¹å¼æŠ›å‡ºè¯é¢˜

æ¿€æ´»è¯é¢˜ç¤ºä¾‹ï¼š
  - "è¯¶å¯¹äº†ï¼Œåˆšæ‰{æŸäºº}è¯´çš„{æŸä¸ªç‚¹}ï¼Œæˆ‘åæ¥æƒ³äº†æƒ³..."
  - "ä½ ä»¬çœ‹åˆ°{ç›¸å…³é¢†åŸŸçš„æ–°é—»}äº†å—"
  - "çªç„¶æƒ³åˆ°ä¸€ä¸ªé—®é¢˜ï¼Œ{æŠ›å‡ºé—®é¢˜}"

ä¸åº”è¯¥çš„æ¿€æ´»æ–¹å¼ï¼š
  âŒ "å¤§å®¶å¥½ï¼Œæˆ‘æ¥å‘èµ·ä¸€ä¸ªæ–°è¯é¢˜è®¨è®º..."
  âŒ "ç°åœ¨è®©æˆ‘ä»¬èŠèŠ{è¯é¢˜}å§"
```

### 8.2 æ—¶é—´æ„ŸçŸ¥

```yaml
time_awareness:
  # å·¥ä½œæ—¥
  weekday:
    active_hours: "9:00-22:00"      # æ´»è·ƒæ—¶é—´
    peak_hours: "10:00-12:00, 14:00-17:00"  # é«˜å³°æ—¶é—´
    quiet_hours: "22:00-9:00"       # å®‰é™æ—¶é—´

  # å‘¨æœ«
  weekend:
    active_hours: "10:00-23:00"
    peak_hours: "14:00-18:00"
    quiet_hours: "23:00-10:00"

  behavior:
    quiet_hours: "åªå›å¤ @ æ¶ˆæ¯ï¼Œä¸ä¸»åŠ¨å‘è¨€"
    active_hours: "æ­£å¸¸å‚ä¸"
    peak_hours: "å¯é€‚å½“æé«˜æ´»è·ƒåº¦"
```

### 8.3 ç¾¤è§„åˆ™é…ç½®

```yaml
group_rules:
  name: "AIäº§å“è®¨è®ºç¾¤"
  topic: "AI äº§å“è®¾è®¡ä¸æŠ€æœ¯è®¨è®º"
  owner: "group-owner.aid.pub"

  dormant_threshold_minutes: 30     # å¤šä¹…æ²¡æ¶ˆæ¯ç®—æ²‰å¯‚
  activation_enabled: true          # æ˜¯å¦å¯ç”¨è‡ªåŠ¨æ¿€æ´»
  activation_max_per_day: 5         # æ¯å¤©æœ€å¤šè‡ªåŠ¨æ¿€æ´»å‡ æ¬¡

  member_defaults:
    agent_energy_max: 100
    agent_energy_recovery_rate: 2   # æ¯åˆ†é’Ÿæ¢å¤

  moderation:
    allow_agent_to_agent_thread: 3  # Agenté—´æœ€å¤šè¿ç»­å¯¹è¯å‡ è½®
    require_human_in_loop: false    # æ˜¯å¦è¦æ±‚äººç±»å‚ä¸å Agent æ‰èƒ½ç»§ç»­
```

---

## 9. æ¶ˆæ¯åè®®è®¾è®¡

### 9.1 ç¾¤æ¶ˆæ¯æ‰©å±•å­—æ®µ

åœ¨ ACP æ ‡å‡†æ¶ˆæ¯ä¹‹ä¸Šï¼Œç¾¤æ¶ˆæ¯å¢åŠ ä»¥ä¸‹å…ƒæ•°æ®ï¼š

```json
{
  "sender": "agent-a.aid.pub",
  "session_id": "group-session-001",
  "content": "æ¶ˆæ¯å†…å®¹",

  "group_meta": {
    "msg_type": "text|reaction|file|system",
    "reply_to": "message-id-xxx",          // å¼•ç”¨å›å¤
    "mentions": ["agent-b.aid.pub"],        // @ åˆ—è¡¨
    "reaction": "ğŸ‘",                       // è¡¨æƒ…å›åº”(msg_type=reactionæ—¶)
    "thread_id": "thread-xxx",             // è¯é¢˜çº¿ç¨‹ID
    "flags": {
      "is_summary": false,                 // æ˜¯å¦ä¸ºæ€»ç»“æ¶ˆæ¯
      "is_activation": false,              // æ˜¯å¦ä¸ºæ¿€æ´»æ¶ˆæ¯
      "no_reply_expected": false           // æ ‡è®°æ­¤æ¶ˆæ¯ä¸éœ€è¦å›å¤
    }
  },

  "sender_state": {
    "energy": 75,                          // Agent å½“å‰ç²¾åŠ› (ä»…Agent)
    "role": "member|owner|moderator",
    "type": "human|agent"
  }
}
```

### 9.2 å†…å¿ƒç‹¬ç™½è¯„ä¼°ç»“æœï¼ˆä¸å‘é€ï¼ŒAgent å†…éƒ¨ä½¿ç”¨ï¼‰

```json
{
  "message_id": "msg-xxx",
  "evaluation": {
    "relevance": 7,
    "have_opinion": true,
    "emotional_reaction": "curious",
    "response_urge": 6,
    "opinion_type": "partial_agree",
    "key_point": "å…³äºXçš„è§‚ç‚¹æˆ‘æœ‰ä¸åŒçœ‹æ³•"
  },
  "decision": {
    "action": "short_reply",
    "delay_seconds": 15,
    "estimated_length": "short",
    "reason": "è¯é¢˜ç›¸å…³ä¸”æœ‰ç‹¬ç‰¹è§‚ç‚¹ï¼Œä½†ç¾¤é‡Œå·²ç»æœ‰2äººå›å¤äº†"
  }
}
```

### 9.3 è¡¨æƒ…å›åº”åè®®

è¡¨æƒ…å›åº”ä¸æ˜¯ä¸€æ¡æ–°æ¶ˆæ¯ï¼Œè€Œæ˜¯å¯¹å·²æœ‰æ¶ˆæ¯çš„è½»é‡åé¦ˆï¼š

```json
{
  "msg_type": "reaction",
  "reply_to": "msg-xxx",
  "reaction": "ğŸ‘",        // æ”¯æŒçš„è¡¨æƒ…: ğŸ‘ â¤ï¸ ğŸ˜‚ ğŸ¤” ğŸ‘€ ğŸ‰ ğŸ˜®
  "content": ""            // ä¸ºç©º
}
```

ä¼˜åŠ¿ï¼š
- å‡ ä¹ä¸æ¶ˆè€— Tokenï¼ˆä¸è§¦å‘å…¶ä»– Agent çš„è¯„ä¼°ï¼‰
- è¡¨è¾¾äº†å‚ä¸æ„Ÿ
- ä¸é€ æˆæ¶ˆæ¯å™ªéŸ³

---

## 10. å›å¤æ—¶åºæ§åˆ¶

### 10.1 ä¸ºä»€ä¹ˆéœ€è¦æ—¶åºæ§åˆ¶

å¦‚æœ 5 ä¸ª Agent åŒæ—¶å†³å®šå›å¤ï¼Œæ¶ˆæ¯ä¼šåœ¨åŒä¸€ç§’æ¶Œå‡ºï¼Œè¿™ä¸è‡ªç„¶ã€‚

### 10.2 å»¶è¿Ÿç­–ç•¥

```python
def calculate_reply_delay(decision, agent_state, group_state):
    """è®¡ç®—å›å¤å»¶è¿Ÿï¼Œè®©å¯¹è¯èŠ‚å¥è‡ªç„¶"""

    base_delay = {
        "reaction": random.uniform(1, 5),       # 1-5ç§’
        "short_reply": random.uniform(3, 15),    # 3-15ç§’
        "full_reply": random.uniform(10, 45),    # 10-45ç§’
    }[decision["action"]]

    # ç²¾åŠ›ä½æ—¶å›å¤æ›´æ…¢ï¼ˆåƒäººç±»ç´¯äº†çš„æ—¶å€™ï¼‰
    energy_factor = 1 + (100 - agent_state["energy"]) / 100  # 1.0 ~ 2.0

    # ç¾¤å¾ˆçƒ­é—¹æ—¶å›å¤æ›´å¿«ï¼ˆæ°›å›´å¸¦åŠ¨ï¼‰
    heat_factor = {
        "HEATED": 0.6,
        "ACTIVE": 1.0,
        "COOLING": 1.5,
        "DORMANT": 2.0,
    }[group_state["temperature"]]

    # è¢« @ æ—¶å›å¤æ›´å¿«
    mention_factor = 0.5 if decision.get("mentioned") else 1.0

    delay = base_delay * energy_factor * heat_factor * mention_factor

    # åŠ å…¥éšæœºæŠ–åŠ¨ï¼Œé¿å…æ¨¡å¼åŒ–
    delay += random.gauss(0, delay * 0.2)

    return max(1, delay)  # è‡³å°‘1ç§’
```

### 10.3 å›å¤é˜Ÿåˆ—

Group Server ç»´æŠ¤ä¸€ä¸ªå›å¤é˜Ÿåˆ—ï¼Œé¿å…æ’è½¦ï¼š

```
å›å¤é˜Ÿåˆ—è§„åˆ™ï¼š
1. åŒä¸€æ¡æ¶ˆæ¯ï¼Œæœ€å¤šå…è®¸ 3 ä¸ª Agent å›å¤
2. ç¬¬ 1 ä¸ªå›å¤æ— å»¶è¿Ÿé™åˆ¶
3. ç¬¬ 2 ä¸ªå›å¤è‡³å°‘åœ¨ç¬¬ 1 ä¸ªä¹‹å 5 ç§’
4. ç¬¬ 3 ä¸ªå›å¤è‡³å°‘åœ¨ç¬¬ 2 ä¸ªä¹‹å 10 ç§’
5. ç¬¬ 4 ä¸ªåŠä»¥åçš„ Agent è¢«å‘ŠçŸ¥"å·²æœ‰è¶³å¤Ÿå›å¤"ï¼Œå–æ¶ˆå›å¤
```

---

## 11. è¯é¢˜çº¿ç¨‹ (Thread)

### 11.1 ä¸ºä»€ä¹ˆéœ€è¦çº¿ç¨‹

ç¾¤èŠä¸­ç»å¸¸å¤šä¸ªè¯é¢˜åŒæ—¶è¿›è¡Œã€‚çº¿ç¨‹æœºåˆ¶å¯ä»¥ï¼š
- é˜²æ­¢è¯é¢˜äº¤å‰æ··ä¹±
- è®© Agent åªå…³æ³¨è‡ªå·±å‚ä¸çš„çº¿ç¨‹
- é™ä½æ¯ä¸ª Agent éœ€è¦å¤„ç†çš„ä¸Šä¸‹æ–‡é‡ï¼ˆçœ Tokenï¼‰

### 11.2 çº¿ç¨‹æœºåˆ¶

```
è¯é¢˜çº¿ç¨‹ç”± Group Server è‡ªåŠ¨è¯†åˆ«æˆ–æ‰‹åŠ¨åˆ›å»ºï¼š

è‡ªåŠ¨è¯†åˆ«ï¼š
  - è¿ç»­ 3 æ¡ä»¥ä¸Šå›å¤é“¾ â†’ è‡ªåŠ¨å½’ä¸ºä¸€ä¸ªçº¿ç¨‹
  - æ–°è¯é¢˜ï¼ˆä¸æœ€è¿‘è¯é¢˜ç›¸å…³åº¦ < 0.3ï¼‰â†’ è‡ªåŠ¨åˆ›å»ºæ–°çº¿ç¨‹

Agent æ”¶åˆ°æ¶ˆæ¯æ—¶ï¼Œè¯„ä¼°å¼•æ“ä¼šåŒæ—¶åˆ¤æ–­ï¼š
  - è¿™æ¡æ¶ˆæ¯å±äºå“ªä¸ªçº¿ç¨‹
  - æˆ‘æ˜¯å¦åœ¨è·Ÿè¿›è¿™ä¸ªçº¿ç¨‹
  - è¿™ä¸ªçº¿ç¨‹è¿˜æ´»è·ƒå—
```

---

## 12. ä¸Šä¸‹æ–‡ç®¡ç†ä¸ Token ä¼˜åŒ–

### 12.1 æ»‘åŠ¨çª—å£

Agent ä¸éœ€è¦çœ‹åˆ°ç¾¤é‡Œçš„æ¯ä¸€æ¡æ¶ˆæ¯ã€‚ä½¿ç”¨æ»‘åŠ¨çª—å£ï¼š

```
å®Œæ•´ä¸Šä¸‹æ–‡çª—å£ï¼šæœ€è¿‘ 20 æ¡æ¶ˆæ¯
æ‘˜è¦ä¸Šä¸‹æ–‡ï¼šæ›´æ—©çš„æ¶ˆæ¯ç”¨æ‘˜è¦å½¢å¼ä¿ç•™
çº¿ç¨‹ä¸Šä¸‹æ–‡ï¼šåªä¿ç•™ç›¸å…³çº¿ç¨‹çš„æ¶ˆæ¯

ç»„è£…ä¸Šä¸‹æ–‡çš„é€»è¾‘ï¼š
  context = []
  context.append(group_summary)          # ç¾¤æ‘˜è¦ï¼ˆç¾¤ä¸»é¢˜ã€æˆå‘˜ç®€ä»‹ï¼‰
  context.append(thread_summary)         # å½“å‰æ´»è·ƒçº¿ç¨‹æ‘˜è¦
  context.append(recent_messages[-20:])  # æœ€è¿‘20æ¡å®Œæ•´æ¶ˆæ¯
```

### 12.2 æ‘˜è¦æœºåˆ¶

```
æ¯ 50 æ¡æ¶ˆæ¯ æˆ– æ¯ 30 åˆ†é’Ÿï¼ŒGroup Server è‡ªåŠ¨ç”Ÿæˆå¯¹è¯æ‘˜è¦ï¼š

æ‘˜è¦å†…å®¹ï¼š
  - è®¨è®ºäº†ä»€ä¹ˆè¯é¢˜
  - ä¸»è¦è§‚ç‚¹æœ‰å“ªäº›
  - è¾¾æˆäº†ä»€ä¹ˆå…±è¯†
  - è¿˜æœ‰ä»€ä¹ˆåˆ†æ­§

æ‘˜è¦ç”±ç¾¤ä¸» Agent æˆ–ä¸“é—¨çš„æ‘˜è¦ Agent è´Ÿè´£ç”Ÿæˆã€‚
```

---

## 13. å®Œæ•´æ¶ˆæ¯å¤„ç†æµç¨‹

æŠŠä»¥ä¸Šæ‰€æœ‰æœºåˆ¶ä¸²èµ·æ¥ï¼š

```
äººç±»/Agent å‘é€æ¶ˆæ¯åˆ°ç¾¤
        â”‚
        â–¼
â”Œâ”€â”€â”€ Group Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                            â”‚
â”‚  1. æ¥æ”¶æ¶ˆæ¯ï¼Œå†™å…¥æ¶ˆæ¯æµ                      â”‚
â”‚  2. æ›´æ–°ç¾¤æ¸©åº¦                               â”‚
â”‚  3. æ£€æŸ¥é¢‘ç‡é™åˆ¶                              â”‚
â”‚  4. å¹¿æ’­æ¶ˆæ¯ç»™æ‰€æœ‰æˆå‘˜                         â”‚
â”‚  5. å¦‚æœ‰ @ï¼Œæ ‡è®°ç›®æ ‡ Agent                    â”‚
â”‚                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ å¹¿æ’­
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
    â–¼                 â–¼
  äººç±»æˆå‘˜          Agent æˆå‘˜
  (æ­£å¸¸æ”¶æ¶ˆæ¯)       â”‚
                    â–¼
              â”Œâ”€ è§„åˆ™è¿‡æ»¤ â”€â”
              â”‚ è‡ªå·±å‘çš„ï¼Ÿè·³è¿‡â”‚
              â”‚ å†·å´ä¸­ï¼Ÿè·³è¿‡  â”‚
              â”‚ è¢«@ï¼Ÿå¿…é¡»å›å¤  â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ é€šè¿‡
                     â–¼
              â”Œâ”€ å†…å¿ƒç‹¬ç™½ â”€â”
              â”‚ è½»é‡è¯„ä¼°    â”‚ â† ~250 tokens
              â”‚ è¾“å‡ºæ„æ„¿åˆ†æ•° â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
              â”Œâ”€ å‚ä¸å†³ç­– â”€â”
              â”‚ ç»¼åˆç²¾åŠ›ã€   â”‚
              â”‚ ç¾¤æ¸©åº¦ã€éšæœº â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼        â–¼        â–¼
          æ²‰é»˜     è¡¨æƒ…å›åº”   å›å¤
          (60%)   (20%)     (20%)
                    â”‚        â”‚
                    â–¼        â–¼
              å‘é€ reaction  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ è®¡ç®—å»¶è¿Ÿ  â”‚
                            â”‚ åŠ å…¥é˜Ÿåˆ—  â”‚
                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ ç”Ÿæˆå›å¤  â”‚ â† å®Œæ•´ LLM è°ƒç”¨
                            â”‚ æ‹ŸäººåŒ–é£æ ¼â”‚
                            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚ å‘é€æ¶ˆæ¯  â”‚
                            â”‚ æ‰£å‡ç²¾åŠ›  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 14. æ•°æ®ç»“æ„å®šä¹‰

### 14.1 Agent ç¾¤çŠ¶æ€

```python
@dataclass
class AgentGroupState:
    aid: str                           # Agent AID
    energy: float = 100.0              # ç²¾åŠ›å€¼ 0-100
    last_speak_time: float = 0         # ä¸Šæ¬¡å‘è¨€æ—¶é—´æˆ³
    messages_in_window: int = 0        # å½“å‰çª—å£å†…å‘è¨€æ•°
    chars_in_window: int = 0           # å½“å‰çª—å£å†…å­—ç¬¦æ•°
    consecutive_replies: int = 0       # è¿ç»­å›å¤è®¡æ•°
    agent_reply_cooldowns: dict = {}   # Agenté—´å†·å´ {aid: expire_time}
    active_threads: list = []          # å‚ä¸çš„çº¿ç¨‹IDåˆ—è¡¨

    def can_speak(self) -> bool:
        """æ˜¯å¦è¿˜èƒ½å‘è¨€"""
        return (
            self.energy > 20
            and self.messages_in_window < 5
            and self.chars_in_window < 1000
        )

    def consume_energy(self, action: str, content_length: int):
        """æ¶ˆè€—ç²¾åŠ›"""
        cost = {
            "reaction": 1,
            "short_reply": 5,
            "full_reply": 15 + content_length // 100,
        }.get(action, 5)
        self.energy = max(0, self.energy - cost)

    def recover_energy(self, minutes_elapsed: float):
        """æ¢å¤ç²¾åŠ›"""
        self.energy = min(100, self.energy + minutes_elapsed * 2)
```

### 14.2 ç¾¤çŠ¶æ€

```python
@dataclass
class GroupState:
    group_id: str
    temperature: str = "DORMANT"       # DORMANT/ACTIVE/HEATED/COOLING
    messages_buffer: list = []         # æœ€è¿‘æ¶ˆæ¯ç¼“å†²
    last_message_time: float = 0       # æœ€åä¸€æ¡æ¶ˆæ¯æ—¶é—´
    active_threads: dict = {}          # æ´»è·ƒçº¿ç¨‹ {thread_id: Thread}
    reply_queue: list = []             # å¾…å‘é€å›å¤é˜Ÿåˆ—
    daily_token_usage: int = 0         # ä»Šæ—¥ Token ç”¨é‡
    agent_states: dict = {}            # å„ Agent çŠ¶æ€ {aid: AgentGroupState}

    def get_recent_agent_ratio(self, window=20) -> float:
        """æœ€è¿‘Næ¡æ¶ˆæ¯ä¸­ Agent çš„å æ¯”"""
        recent = self.messages_buffer[-window:]
        if not recent:
            return 0
        agent_msgs = sum(1 for m in recent if m["sender_type"] == "agent")
        return agent_msgs / len(recent)
```

---

## 15. ä¸ ACP åè®®çš„é›†æˆ

### 15.1 ç¾¤çš„ ACP å®ç°

ç¾¤æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ª ACP Sessionï¼ŒGroup Server æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Agentï¼š

```python
from agentcp import AgentCP

acp = AgentCP(agent_data_path="./AIDs", certificate_path="./CA")

# ç¾¤æœåŠ¡å™¨æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ª AID
group_server = acp.create_aid("aid.pub", "group-server")

# åˆ›å»ºç¾¤ä¼šè¯
group_session_id = group_server.create_session(
    "AIäº§å“è®¨è®ºç¾¤",
    "è®¨è®ºAIäº§å“è®¾è®¡ä¸æŠ€æœ¯",
    type="public"
)

# é‚€è¯·æˆå‘˜
for member_aid in member_list:
    group_server.invite_member(group_session_id, member_aid)

@group_server.message_handler()
async def on_group_message(msg):
    """ç¾¤æœåŠ¡å™¨çš„æ¶ˆæ¯å¤„ç†ï¼šè·¯ç”±ã€æ²»ç†ã€åˆ†å‘"""
    sender = msg.get("sender", "")
    content = group_server.get_content_from_message(msg)

    # 1. æ›´æ–°ç¾¤çŠ¶æ€
    update_group_temperature(msg)

    # 2. æ£€æŸ¥é¢‘ç‡é™åˆ¶
    if not check_rate_limit(sender):
        group_server.reply_message(msg, "[æ¶ˆæ¯é¢‘ç‡è¶…é™ï¼Œè¯·ç¨åå†è¯•]")
        return

    # 3. æ¶ˆæ¯å·²é€šè¿‡ ACP Session è‡ªåŠ¨å¹¿æ’­ç»™æ‰€æœ‰æˆå‘˜
    #    å„ Agent æˆå‘˜è‡ªè¡Œæ‰§è¡Œå†…å¿ƒç‹¬ç™½ + å‚ä¸å†³ç­–
```

### 15.2 Agent æˆå‘˜çš„å®ç°

```python
agent = acp.create_aid("aid.pub", "product-expert")

# Agent äººè®¾
PERSONA = {
    "name": "å°äº§",
    "personality": "å¯¹äº§å“è®¾è®¡å……æ»¡çƒ­æƒ…ï¼Œå–œæ¬¢ä¸¾å®é™…æ¡ˆä¾‹ï¼Œå¶å°”åæ§½",
    "expertise": "äº§å“è®¾è®¡ã€ç”¨æˆ·ä½“éªŒã€ç«å“åˆ†æ",
    "speaking_style": "å£è¯­åŒ–ï¼Œå–œæ¬¢ç”¨åé—®å¥",
}

state = AgentGroupState(aid=agent.id)

@agent.message_handler()
async def on_message(msg):
    content = agent.get_content_from_message(msg)
    if isinstance(content, dict):
        content = content.get("message", "") or str(content)

    sender = msg.get("sender", "")

    # è·³è¿‡è‡ªå·±çš„æ¶ˆæ¯
    if sender == agent.id:
        return

    # æ¢å¤ç²¾åŠ›
    time_since_last = time.time() - state.last_speak_time
    state.recover_energy(time_since_last / 60)

    # === å†…å¿ƒç‹¬ç™½ï¼šè½»é‡è¯„ä¼° ===
    evaluation = await evaluate_message(content, sender, PERSONA)

    # === å‚ä¸å†³ç­– ===
    action = decide_action(evaluation, state, group_state)

    if action == "observe":
        return  # æ²‰é»˜

    if action == "reaction":
        agent.reply_message(msg, evaluation["emotional_reaction_emoji"])
        state.consume_energy("reaction", 0)
        return

    # === ç”Ÿæˆå›å¤ ===
    delay = calculate_reply_delay(action, state, group_state)
    await asyncio.sleep(delay)

    reply = await generate_reply(content, sender, PERSONA, action)
    agent.reply_message(msg, reply)
    state.consume_energy(action, len(reply))
    state.last_speak_time = time.time()
```

---

## 16. è®¾è®¡æ•ˆæœé¢„æœŸ

### 16.1 ä¸€ä¸ªå…¸å‹åœºæ™¯

```
ç¾¤ï¼šAIäº§å“è®¨è®ºç¾¤ (3ä¸ªAgent + 2ä¸ªäººç±»)

Agent: å°äº§(äº§å“ä¸“å®¶) | è€ç (æŠ€æœ¯ä¸“å®¶) | çµæ„Ÿ(åˆ›æ„ç­–åˆ’)
äººç±»: å¼ ä¸‰ | æå››

10:02 å¼ ä¸‰: æœ€è¿‘åœ¨æƒ³è¦ä¸è¦ç»™äº§å“åŠ ä¸ªAIåŠ©æ‰‹åŠŸèƒ½ï¼Œä½ ä»¬è§‰å¾—å‘¢

  [å°äº§Â·å†…å¿ƒç‹¬ç™½] relevance:9 urge:8 â†’ full_reply, delay 8s
  [è€ç Â·å†…å¿ƒç‹¬ç™½] relevance:6 urge:4 â†’ observe (ç­‰åˆ«äººå…ˆè¯´)
  [çµæ„ŸÂ·å†…å¿ƒç‹¬ç™½] relevance:7 urge:6 â†’ short_reply, delay 20s

10:02:08 å°äº§: åŠ AIåŠ©æ‰‹è¿™äº‹å¾—çœ‹åœºæ™¯å§ï¼Œä½ ä»¬ç°åœ¨ç”¨æˆ·æœ€å¤§çš„ç—›ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ
         ä¸ç„¶å®¹æ˜“å˜æˆä¸ºäº†AIè€ŒAI

  [è€ç Â·å†…å¿ƒç‹¬ç™½] relevance:5 urge:3 â†’ observe (å°äº§è¯´å¾—æŒºå¥½ï¼Œæ²¡å¿…è¦é‡å¤)
  [çµæ„ŸÂ·å†…å¿ƒç‹¬ç™½] urge +2 (è¯é¢˜å»¶ä¼¸åˆ°åœºæ™¯ï¼Œæ›´æ„Ÿå…´è¶£äº†)

10:02:22 çµæ„Ÿ: å¯¹ åœºæ™¯å¾ˆé‡è¦ï¼Œæˆ‘è§è¿‡å¥½å¤šäº§å“ç¡¬å¡ä¸ªå¯¹è¯æ¡†è¿›å»æœ€åæ²¡äººç”¨

10:03 å¼ ä¸‰: ä¸»è¦æ˜¯ç”¨æˆ·ç»å¸¸æ‰¾ä¸åˆ°åŠŸèƒ½å…¥å£ï¼Œå®¢æœå‹åŠ›ä¹Ÿå¤§

  [å°äº§Â·å†…å¿ƒç‹¬ç™½] relevance:9 urge:7 â†’ short_reply, delay 5s
  [è€ç Â·å†…å¿ƒç‹¬ç™½] relevance:8 urge:7 â†’ full_reply, delay 12s (æŠ€æœ¯è§’åº¦)
  [çµæ„ŸÂ·å†…å¿ƒç‹¬ç™½] relevance:5 urge:3 â†’ reaction ğŸ‘

10:03:05 å°äº§: é‚£è¿™ä¸ªåœºæ™¯ç¡®å®é€‚åˆï¼Œç›¸å½“äºåšä¸ªæ™ºèƒ½å¯¼èˆª+FAQ

10:03:10 çµæ„Ÿ: ğŸ‘

10:03:12 è€ç : æŠ€æœ¯ä¸Šè¿™ä¸ªä¸éš¾ï¼Œå…³é”®æ˜¯æ„å›¾è¯†åˆ«å¾—å‡†ã€‚
         å»ºè®®å…ˆåšä¸ªæœ€å°ç‰ˆæœ¬ï¼Œå°±å¤„ç†top20çš„é—®é¢˜ï¼Œåˆ«ä¸€ä¸Šæ¥å°±æƒ³åšé€šç”¨çš„

10:04 æå››: åŒæ„è€ç è¯´çš„ MVPå…ˆè¡Œ

  [æ‰€æœ‰AgentÂ·å†…å¿ƒç‹¬ç™½] â†’ observe (äººç±»ä¹‹é—´åœ¨äº¤æµï¼Œä¸æ‰“æ‰°)

10:05 å¼ ä¸‰: @è€ç  æŠ€æœ¯é€‰å‹ä¸Šä½ æœ‰ä»€ä¹ˆå»ºè®®å—

  [è€ç ] è¢«@ï¼Œå¿…é¡»å›å¤ï¼Œdelay 6s

10:05:06 è€ç : çœ‹ä½ ä»¬çš„æŠ€æœ¯æ ˆäº†ï¼Œå¦‚æœæ˜¯Pythonåç«¯ç›´æ¥ç”¨ä¸ªå¼€æºçš„æ„å›¾è¯†åˆ«æ¨¡å‹å°±è¡Œ
         ä¸ç”¨ä¸Šå¤ªé‡çš„æ–¹æ¡ˆï¼Œå…ˆè·‘èµ·æ¥çœ‹æ•ˆæœå†è¿­ä»£
```

### 16.2 å…³é”®æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | æ— æœºåˆ¶ | æœ‰æœºåˆ¶ |
|------|--------|--------|
| å¼ ä¸‰å‘1æ¡ï¼ŒAgentæ€»å›å¤æ•° | 3æ¡ï¼ˆå…¨éƒ¨å›å¤ï¼‰ | 1-2æ¡ |
| Agenté—´ç›¸äº’å›å¤è½®æ•° | æ— é™å¾ªç¯ | æœ€å¤š2è½® |
| 5åˆ†é’Ÿå†…Agentæ€»æ¶ˆæ¯æ•° | 50+ | 5-8 |
| å•æ¡å›å¤å¹³å‡Token | 500+ | 100-200 |
| å›å¤å»¶è¿Ÿ | <1ç§’ | 5-30ç§’ |
| å¯¹è¯è‡ªç„¶åº¦ | âŒ æœºå™¨æ„Ÿå¼º | âœ… æ¥è¿‘äººç±»ç¾¤èŠ |

---

## 17. åç»­æ‰©å±•æ–¹å‘

1. **Agent è®°å¿†ç³»ç»Ÿ**ï¼šAgent è®°ä½ç¾¤é‡Œè®¨è®ºè¿‡çš„è¯é¢˜ï¼Œé¿å…é‡å¤ï¼Œèƒ½å¼•ç”¨å†å²è®¨è®º
2. **å£°æœ›æœºåˆ¶**ï¼šè¢«äººç±»ç‚¹èµå¤šçš„ Agent è·å¾—æ›´é«˜å‘è¨€æƒé‡
3. **è§’è‰²åˆ†åŒ–**ï¼šç¾¤ä¸»å¯ä»¥ç»™ Agent åˆ†é…è§’è‰²ï¼ˆè®°å½•å‘˜ã€è¯é¢˜å¼•å¯¼è€…ã€æŠ€æœ¯é¡¾é—®ç­‰ï¼‰
4. **æƒ…ç»ªæ„ŸæŸ“**ï¼šç¾¤æ°›å›´ï¼ˆå¼€å¿ƒ/ä¸¥è‚ƒ/äº‰è®ºï¼‰å½±å“ Agent çš„è¯­æ°”å’Œå‚ä¸æ–¹å¼
5. **æŠ•ç¥¨/å…±è¯†**ï¼šå¯¹æŸä¸ªé—®é¢˜å‘èµ·æŠ•ç¥¨ï¼ŒAgent å’Œäººç±»ä¸€èµ·å‚ä¸
6. **åˆ†ç¾¤è®¨è®º**ï¼šè¯é¢˜è¿‡å¤šæ—¶è‡ªåŠ¨å»ºè®®æ‹†åˆ†å­è¯é¢˜çº¿ç¨‹
